<br><br>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>LLM Council — Secure Edition</title>

<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: transparent;
    --text: #222;
    --panel: #ffffff;
    --border: #e0e0e0;
    --subtle: #777;
    --placeholder: #9a9a9a;
  }

  body {
    font-family: "Lato", sans-serif;
    max-width: 860px;
    margin: 40px auto;
    padding: 20px;
    background: transparent;
    color: var(--text);
  }

  h1 { margin-bottom: 6px; font-weight: 800; }

  .subtitle {
    font-size: 0.9em;
    color: var(--subtle);
    margin-bottom: 18px;
  }

  .prompt-wrap {
    position: relative;
  }

  textarea {
    width: 100%;
    min-height: 60px;
    max-height: 220px;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: #ffffff;
    color: var(--text);
    font-size: 16px;
    resize: none;
    overflow-y: auto;
  }
  textarea.disabled {
    background: #e6e6e6;
    color: #777;
  }

  #stop-icon {
    position: absolute;
    bottom: 10px;
    right: 12px;
    width: 18px;
    height: 18px;
    background: #444;
    border-radius: 3px;
    cursor: pointer;
    display: none;
  }

  button {
    background: #000;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 10px 22px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 12px;
  }
  button:hover:enabled { background: #111; }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }

  /* Status box */
  #status-box {
    margin-top: 16px;
    margin-bottom: 12px;
    padding: 10px 14px;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.92em;
  }
  #status-line {
    color: #666;
    margin-bottom: 4px;
  }
  #status-subline {
    color: var(--placeholder);
  }

  .placeholder-style {
    color: var(--placeholder);
  }

  /* Chat history container and bubbles */
  #chat-container {
    margin-top: 10px;
    margin-bottom: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .chat-msg {
    max-width: 90%;
    padding: 10px 12px;
    border-radius: 12px;
    line-height: 1.5;
    font-size: 0.96em;
  }
  .user-msg {
    background: #e8e8e8;
    margin-left: auto;
  }
  .bot-msg {
    background: #ffffff;
    border: 1px solid #ddd;
    margin-right: auto;
  }

  .bot-main {
    margin-bottom: 8px;
  }

  .bot-council {
    border-top: 1px solid #eee;
    padding-top: 6px;
    font-size: 0.88em;
    color: var(--subtle);
  }

  .bot-council-title {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .bot-council-lines {
    margin-bottom: 4px;
  }

  .bot-council-lines div {
    margin: 1px 0;
  }

  .bot-council-actions {
    margin-top: 4px;
  }

  .council-details-link,
  .council-open-ranking {
    cursor: pointer;
    text-decoration: underline;
  }

  .council-open-ranking {
    margin-left: 8px;
  }

  .council-transcripts {
    margin-top: 6px;
    display: none;
  }

  /* Collapsible transcripts */
  .transcript-card {
    margin-top: 6px;
    border-radius: 6px;
    border: 1px solid #e3e3e3;
    background: #fcfcfc;
    overflow: hidden;
  }
  .transcript-header {
    padding: 6px 10px;
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 0.85em;
  }
  .transcript-header .model {
    font-weight: 600;
    flex: 1;
  }
  .transcript-header .meta {
    font-size: 0.78em;
    color: var(--subtle);
    margin-right: 6px;
  }
  .transcript-header .chevron {
    font-size: 0.78em;
    transition: transform 0.15s ease;
  }
  .transcript-card.open .chevron {
    transform: rotate(90deg);
  }
  .transcript-body {
    padding: 8px 10px 10px;
    border-top: 1px solid #eee;
    font-size: 0.85em;
    display: none;
  }
  .transcript-card.open .transcript-body {
    display: block;
  }

  /* Ranking slide-out */
  #ranking-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 320px;
    height: 100%;
    background: #f7f7f7;
    border-left: 1px solid #ccc;
    transform: translateX(100%);
    transition: transform 0.25s ease;
    padding: 16px;
    overflow-y: auto;
    z-index: 9999;
  }
  /* Mobile fix: lower slide-out so Google Sites header doesn't cover the X */
@media (max-width: 768px) {
  #ranking-panel {
    top: 70px !important;   /* Adjust this higher/lower until X is fully visible */
    height: calc(100% - 70px) !important;
  }
}

/* Mobile-safe slide-out offset */
@media (max-width: 600px) {
  #ranking-panel {
    top: 60px;   /* adjust 40–90 depending on Google Sites header */
    height: calc(100% - 60px);
  }
} 
  #ranking-panel.open {
    transform: translateX(0);
  }
  #ranking-close {
    text-align: end;
    cursor: pointer;
    margin-bottom: 40px;
  }
 /* Ranking panel text size patch */
#ranking-body {
  font-size: 0.85em;
}
#ranking-body .ranking-row {
  font-size: 0.85em;
}
#ranking-body strong {
  font-size: 0.9em;
}
  .ranking-row {
    border-radius: 6px;
    background: #ffffff;
    border: 1px solid #e2e2e2;
    padding: 8px 10px;
    margin-bottom: 6px;
  }

  /* Dots animation */
  .dots span {
    animation: blink 1.2s infinite;
    opacity: 0.2;
  }
  .dots span:nth-child(2) { animation-delay: 0.2s; }
  .dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink {
    0% { opacity: 0.2; }
    50% { opacity: 1; }
    100% { opacity: 0.2; }
  }

  .info-icon {
    font-family: Lato, sans-serif;
    font-size: 10px;
    font-weight: 700;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1.5px solid #666;
    color: #666;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: default;
    position: relative;
  }

  .info-icon:hover {
    background: #666;
    color: white;
  }

  .info-tooltip {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    top: 26px;
    left: 0;
    width: 260px;
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 10px 12px;
    font-size: 12px;
    line-height: 1.45;
    border-radius: 6px;
    transition: opacity 0.25s ease;
    z-index: 999;
  }

  .info-icon:hover .info-tooltip {
    visibility: visible;
    opacity: 1;
  }

  /* Dark mode toggle icon */
  .theme-icon {
    margin-left: auto;
    cursor: pointer;
    font-size: 18px;
    opacity: 0.7;
  }
  .theme-icon:hover {
    opacity: 1;
  }

  /* Dark mode theme */
  body.dark-mode {
    background: #111 !important;
    color: #eee;
  }
  body.dark-mode textarea {
    background: #1d1d1d;
    color: #eee;
    border-color: #444;
  }
  body.dark-mode #status-box {
    background: #1a1a1a;
    border-color: #444;
  }
  body.dark-mode .ranking-row {
    background: #1a1a1a;
    border-color: #444;
  }
  body.dark-mode .transcript-card {
    background: #1a1a1a;
    border-color: #444;
  }
  body.dark-mode .transcript-body {
    background: #1a1a1a;
  }
  body.dark-mode .user-msg {
    background: #333;
    color: #eee;
  }
  body.dark-mode .bot-msg {
    background: #222;
    color: #eee;
    border-color: #444;
  }
  body.dark-mode #ranking-panel {
    background: #161616;
    border-color: #444;
  }

  footer {
    margin-top: 32px;
    text-align: center;
    font-size: 11px;
    color: #777;
    font-family: Lato, sans-serif;
  }
</style>
</head>
<body>

<h1 style="display:flex; align-items:center; gap:8px;">
  LLM Council
  <span class="info-icon">i
    <span class="info-tooltip">
      The LLM Council serves as an advisory board of models. Instead of relying on a single LLM, 
      your question is evaluated by multiple different models independently. Each produces an 
      initial answer, then anonymously reviews and ranks the others. Finally, a designated 
      Chairman synthesizes these perspectives into one final high-signal response. This 
      multi-model deliberation produces more reliable, insightful output than any single 
      model alone.
    </span>
  </span>
  <span id="theme-toggle" class="theme-icon">☾</span>
</h1>

<br>

<div class="subtitle">
  Council stack: Groq Llama-3.1 8B, Groq Llama-3.3 70B, GPT-OSS-20B,
  LLaMA-3.1 8B Instruct, Kimi-K2, DeepSeek V3, DeepSeek Chat,
  DeepSeek Reasoner, Gemini Flash 2.0.
</div>

<!-- Chat history -->
<div id="chat-container"></div>

<!-- Status box moved here, above prompt -->
<div id="status-box">
  <div id="status-line" class="placeholder-style">Status: Ready</div>
  <div id="status-subline" class="placeholder-style">Waiting for your question…</div>
</div>

<div class="prompt-wrap">
  <textarea id="prompt" placeholder="&quot;don't ask questions you don't want the answer to…&quot; -Agent J (MiB)"></textarea>
  <div id="stop-icon"></div>
</div>

<button id="ask">Ask the Council</button>

<!-- Ranking slide-out -->
<div id="ranking-panel">
  <div id="ranking-close">✕</div>
  <div id="ranking-body"></div>
</div>

<script>
const BACKEND_URL = "https://llm-council-backend-gyqc.onrender.com/council";

function md(text) {
  return text
    .trim()
    .replace(/^\s*\n+/g, "")
    .replace(/\n{3,}/g, "\n\n")
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.*?)\*/g, "<em>$1</em>")
    .replace(/`([^`]+)`/g, "<code>$1</code>")
    .replace(/\n/g, "<br>");
}

function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function isMobile() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

const askBtn        = document.getElementById("ask");
const promptBox     = document.getElementById("prompt");
const stopIcon      = document.getElementById("stop-icon");
const statusLine    = document.getElementById("status-line");
const statusSubline = document.getElementById("status-subline");
const chatContainer = document.getElementById("chat-container");
const rankingPanel  = document.getElementById("ranking-panel");
const rankingClose  = document.getElementById("ranking-close");
const rankingBody   = document.getElementById("ranking-body");
const themeToggle   = document.getElementById("theme-toggle");

let controller = null;
let timerId    = null;

/* Dark mode load */
(function applyThemeFromStorage() {
  const t = localStorage.getItem("llm_theme");
  if (t === "dark") {
    document.body.classList.add("dark-mode");
    if (themeToggle) themeToggle.textContent = "☀";
  }
})();

if (themeToggle) {
  themeToggle.onclick = () => {
    const dark = document.body.classList.toggle("dark-mode");
    themeToggle.textContent = dark ? "☀" : "☾";
    localStorage.setItem("llm_theme", dark ? "dark" : "light");
  };
}

function lockPrompt() {
  promptBox.classList.add("disabled");
  promptBox.disabled = true;
}
function unlockPrompt() {
  promptBox.classList.remove("disabled");
  promptBox.disabled = false;
}

function autoResize() {
  promptBox.style.height = "auto";
  const maxHeight = 220;
  const newHeight = Math.min(maxHeight, promptBox.scrollHeight);
  promptBox.style.height = newHeight + "px";
}

promptBox.addEventListener("input", autoResize);
autoResize();

/* Desktop: Enter sends. Mobile: Enter = newline only */
promptBox.addEventListener("keydown", e => {
  if (!isMobile()) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      askBtn.click();
    }
  }
});

stopIcon.onclick = () => {
  if (controller) controller.abort();
  if (timerId) clearInterval(timerId);
  stopIcon.style.display = "none";
  askBtn.disabled = false;
  unlockPrompt();
  statusLine.textContent    = "Stopped.";
  statusSubline.textContent = "";
};

rankingClose.onclick  = () => rankingPanel.classList.remove("open");

askBtn.onclick = async () => {
  const promptText = promptBox.value;
  const prompt = promptText.trim();
  if (!prompt) {
    alert("Type a question first.");
    return;
  }

  // Append user message bubble
  const userDiv = document.createElement("div");
  userDiv.className = "chat-msg user-msg";
  userDiv.innerHTML = escapeHtml(promptText);
  chatContainer.appendChild(userDiv);

  // Clear prompt for next message & resize
  promptBox.value = "";
  autoResize();

  controller = new AbortController();
  askBtn.disabled = true;
  lockPrompt();
  stopIcon.style.display = "block";

  statusLine.textContent = "Thinking… 0s (council may take 20–60s)";
  statusLine.classList.remove("placeholder-style");
  statusSubline.innerHTML =
    `<span class="placeholder-style">Council is thinking<span class="dots"><span>.</span><span>.</span><span>.</span></span></span>`;

  const start = Date.now();
  timerId = setInterval(() => {
    const s = Math.floor((Date.now() - start) / 1000);
    statusLine.textContent = `Thinking… ${s}s (council may take 20–60s)`;
  }, 1000);

  try {
    const r = await fetch(BACKEND_URL, {
      method: "POST",
      signal: controller.signal,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const data = await r.json();
    if (timerId) clearInterval(timerId);
    stopIcon.style.display = "none";
    askBtn.disabled = false;
    unlockPrompt();

    if (data.error) {
      statusLine.textContent    = "Error.";
      statusSubline.textContent = "";
      return;
    }

    const used  = data.modelsUsed?.length || 0;
    const total = data.modelsAttempted?.length || used;

    statusLine.textContent = `Done. Used ${used}/${total}. Chairman: ${data.chairman}`;
    statusSubline.textContent = "";

    // Build assistant bubble
    const botDiv = document.createElement("div");
    botDiv.className = "chat-msg bot-msg";

    const mainDiv = document.createElement("div");
    mainDiv.className = "bot-main";
    mainDiv.innerHTML = md(data.final || "No final answer.");

    const councilDiv = document.createElement("div");
    councilDiv.className = "bot-council";

    const titleDiv = document.createElement("div");
    titleDiv.className = "bot-council-title";
    titleDiv.textContent = "Council Top Picks:";

    const linesDiv = document.createElement("div");
    linesDiv.className = "bot-council-lines";

    if (data.ranking && data.ranking.length) {
      const top = data.ranking.slice(0, 3);
      top.forEach((pos, i) => {
        const idx   = pos - 1;
        const model = data.modelsUsed[idx];
        const pct   = data.percentages[idx];
        const conf  = data.avgConfidences[idx]?.toFixed(2);
        const line  = document.createElement("div");
        line.textContent = `#${i + 1} ${model} — ${pct}% (avg conf ${conf})`;
        linesDiv.appendChild(line);
      });
    } else {
      const line = document.createElement("div");
      line.textContent = "No ranking available.";
      linesDiv.appendChild(line);
    }

    const actionsDiv = document.createElement("div");
    actionsDiv.className = "bot-council-actions";

    const detailsLink = document.createElement("span");
    detailsLink.className = "council-details-link";
    detailsLink.textContent = "View council details ▸";

    const openRankingLink = document.createElement("span");
    openRankingLink.className = "council-open-ranking";
    openRankingLink.textContent = "Open ranking panel";

    actionsDiv.appendChild(detailsLink);
    actionsDiv.appendChild(openRankingLink);

    const transcriptsWrap = document.createElement("div");
    transcriptsWrap.className = "council-transcripts";

    // transcripts as collapsible cards (inside this bubble)
    if (Array.isArray(data.transcripts)) {
      data.transcripts.forEach((t) => {
        const card = document.createElement("div");
        card.className = "transcript-card";

        const header = document.createElement("div");
        header.className = "transcript-header";

        const modelSpan = document.createElement("span");
        modelSpan.className = "model";
        modelSpan.textContent = t.model;

        const metaSpan = document.createElement("span");
        metaSpan.className = "meta";
        const idx = data.modelsUsed.indexOf(t.model);
        if (idx !== -1) {
          const pct  = data.percentages[idx];
          const conf = data.avgConfidences[idx]?.toFixed(2);
          metaSpan.textContent = `Score: ${pct}% · Conf: ${conf}`;
        }

        const chev = document.createElement("span");
        chev.className = "chevron";
        chev.textContent = "▸";

        header.appendChild(modelSpan);
        header.appendChild(metaSpan);
        header.appendChild(chev);

        const body = document.createElement("div");
        body.className = "transcript-body";
        body.innerHTML = md(t.answer);

        header.onclick = () => card.classList.toggle("open");

        card.appendChild(header);
        card.appendChild(body);
        transcriptsWrap.appendChild(card);
      });
    }

    // toggle transcripts section
    let transcriptsVisible = false;
    detailsLink.onclick = () => {
      transcriptsVisible = !transcriptsVisible;
      transcriptsWrap.style.display = transcriptsVisible ? "block" : "none";
    };

    // open ranking slide-out panel
    openRankingLink.onclick = () => {
      rankingPanel.classList.add("open");
    };

    councilDiv.appendChild(titleDiv);
    councilDiv.appendChild(linesDiv);
    councilDiv.appendChild(actionsDiv);
    councilDiv.appendChild(transcriptsWrap);

    botDiv.appendChild(mainDiv);
    botDiv.appendChild(councilDiv);
    chatContainer.appendChild(botDiv);

    // build ranking slide-out content for this turn
    if (data.ranking && data.ranking.length) {
      let html = `<h3>Council ranking</h3>`;
      data.ranking.forEach((pos, i) => {
        const idx   = pos - 1;
        const model = data.modelsUsed[idx];
        const pct   = data.percentages[idx];
        const conf  = data.avgConfidences[idx]?.toFixed(2);
        html += `
          <div class="ranking-row">
            <strong>#${i + 1} — ${model}</strong>
            <span class="meta">Weighted: ${pct}% · Avg conf: ${conf}</span>
          </div>
        `;
      });
      html += `<p><strong>Reason:</strong> ${data.rankingReason || "N/A"}</p>`;
      rankingBody.innerHTML = html;
    } else {
      rankingBody.innerHTML = "<p>No ranking data for this turn.</p>";
    }

    // Scroll to bottom to show latest messages
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

  } catch (err) {
    if (timerId) clearInterval(timerId);
    stopIcon.style.display = "none";
    askBtn.disabled = false;
    unlockPrompt();
    statusLine.textContent    = "Network error or stopped.";
    statusSubline.textContent = "";
  }
};
</script>

<footer>
  Inspired by @karpathy’s original Council. Adapted and designed by Kyle.<br><br>
  <small>⚙️ 2025-2026</small>
</footer>

</body>
</html>
